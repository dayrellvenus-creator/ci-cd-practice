stages:
  - test
  - build

variables:
  IMAGE_NAME: "$CI_REGISTRY_IMAGE/ci-cd-practice"

test:
  image: node:18
  stage: test
  script:
    - npm ci
    - npm test
  artifacts:
    when: always
    reports:
      junit: report.xml
    paths:
      - node_modules/

build:
  image: docker:24
  stage: build
  services:
    - docker:24-dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  script:
    - docker build -t "$IMAGE_NAME:latest" .
    # To push, log in and push (requires CI registry credentials) :
    # - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
    # - docker push "$IMAGE_NAME:latest"
